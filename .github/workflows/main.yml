name: build

on: [push, pull_request]

jobs:
  build-windows-msvc:
    runs-on: windows-2022
    strategy:
      matrix:
        standard: ['11', '14', '17', '20']
        config: ['Release', 'Debug']
        precompile: ['ON', 'OFF']
    steps:
      - name: Get number of CPU cores
        uses: SimenB/github-actions-cpu-cores@v2
        id: cpu-cores
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup MSVC 2017
        run: |
          choco install visualstudio2017buildtools --no-progress --ignore-checksums
          call "C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
      - name: Configure
        shell: cmd
        run: |
            cmake -B build/ -G "Visual Studio 15 2017 Win64" -DTOML11_BUILD_TESTS=ON -DCMAKE_CXX_STANDARD=${{ matrix.standard }} -DTOML11_PRECOMPILE=${{ matrix.precompile }}
      - name: Build
        run: |
            cmake --build ./build --config "${{ matrix.config }}" -j${{ steps.cpu-cores.outputs.count }}
      - name: Test
        run: |
            ctest --build-config "${{ matrix.config }}" --test-dir build/ --output-on-failure
